import type { FormData } from "@/app/documents/page"

export async function generatePDF(formData: FormData) {
  const isApartment = formData.propertyType === "apartment"
  const needsCoOwnerDocs = isApartment && formData.hasCoOwnerConsent === "no"

  // Import html2pdf dynamically (browser only)
  const html2pdf = (await import("html2pdf.js")).default

  const htmlContent = `
    <div style="font-family: Arial, sans-serif; padding: 20px; font-size: 11px; line-height: 1.5;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px; text-align: center; margin: -20px -20px 20px -20px;">
        <h1 style="margin: 0; font-size: 24px; font-weight: bold;">EV CHARGING STATION DOCUMENTS</h1>
        <p style="margin: 5px 0 0 0; font-size: 14px;">Legal Document Package</p>
        <p style="margin: 5px 0 0 0; font-size: 10px;">${new Date().toLocaleDateString()}</p>
      </div>
      
      <!-- Document 1: Application -->
      <div style="background: #f3f4f6; padding: 8px; margin: 20px 0 10px 0;">
        <h2 style="margin: 0; font-size: 16px; font-weight: bold;">DOCUMENT #1: APPLICATION</h2>
      </div>
      
      <h3 style="text-align: center; font-size: 13px; margin: 15px 0;">Application for EV Charging Station Installation</h3>
      
      ${isApartment ? `
        <p><strong>Address: ${formData.address}</strong></p>
        <p>To the apartment building owners</p>
      ` : `
        <p><strong>Address: ${formData.address}</strong></p>
      `}
      
      <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">APPLICANT INFORMATION:</h4>
      <p><strong>Full Name:</strong> ${formData.fullName}</p>
      <p><strong>Personal Code:</strong> ${formData.personalCode}</p>
      <p><strong>Address:</strong> ${formData.address}</p>
      ${isApartment ? `<p><strong>Apartment Number:</strong> ${formData.apartmentNumber}</p>` : ""}
      <p><strong>Phone:</strong> ${formData.phone}</p>
      <p><strong>Email:</strong> ${formData.email}</p>
      
      <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">
        ${isApartment ? "I REQUEST PERMISSION TO INSTALL:" : "I INFORM ABOUT THE INTENTION TO INSTALL:"}
      </h4>
      <p>An electric vehicle charging station ${
        isApartment ? `at parking space No. ${formData.parkingSpot}` : "on my property"
      }, located ${formData.parkingLocation}.</p>
      
      <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">CHARGING STATION PARAMETERS:</h4>
      <ul style="margin: 5px 0; padding-left: 20px;">
        <li>Type: ${formData.chargerType}</li>
        <li>Power: ${formData.power} kW</li>
        <li>Number of connectors: ${formData.connectors}</li>
        ${formData.chargerModel ? `<li>Model: ${formData.chargerModel}</li>` : ""}
      </ul>
      
      <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">COMMITMENTS:</h4>
      <ul style="margin: 5px 0; padding-left: 20px;">
        <li>Comply with all construction and electrical safety requirements</li>
        <li>Use only certified and new equipment</li>
        <li>Commission installation works to certified contractor with VERT certificate</li>
        <li>Properly operate and maintain the installed station</li>
        ${isApartment ? "<li>Compensate for damage to common objects, if any</li>" : ""}
      </ul>
      
      <div style="margin-top: 40px;">
        <p>Applicant: ___________________________</p>
        <p style="margin-left: 80px;">(${formData.fullName})</p>
        <p>Date: ${new Date().toLocaleDateString()}</p>
      </div>
      
      ${
        needsCoOwnerDocs
          ? `
        <div style="page-break-before: always; padding-top: 20px;">
          <div style="background: #f3f4f6; padding: 8px; margin: 0 0 10px 0;">
            <h2 style="margin: 0; font-size: 16px; font-weight: bold;">DOCUMENT #2: CO-OWNER CONSENT FORM</h2>
          </div>
          
          <h3 style="text-align: center; font-size: 13px; margin: 15px 0;">
            Apartment Building ${formData.address}<br/>
            CO-OWNERS CONSENT<br/>
            FOR EV CHARGING STATION INSTALLATION
          </h3>
          
          <p>We, the undersigned apartment and premises owners, <strong>CONSENT</strong> to ${formData.fullName}, owner of apartment No. ${formData.apartmentNumber}, installing an electric vehicle charging station at parking space No. ${formData.parkingSpot}.</p>
          
          <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">CHARGING STATION PARAMETERS:</h4>
          <ul style="margin: 5px 0; padding-left: 20px;">
            <li>Power: ${formData.power} kW</li>
            <li>Type: ${formData.chargerType}</li>
            <li>Number of connectors: ${formData.connectors}</li>
          </ul>
          
          <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">CONDITIONS:</h4>
          <ol style="margin: 5px 0; padding-left: 20px;">
            <li>Station will be installed according to construction and electrical requirements</li>
            <li>Only certified and new equipment will be used</li>
            <li>Works will be performed by certified contractor with VERT certificate</li>
            <li>ESO connection conditions will be obtained and fulfilled</li>
            <li>Applicant commits to compensate for damage, if any</li>
          </ol>
          
          <h4 style="margin-top: 20px; font-size: 12px; font-weight: bold;">CO-OWNERS SIGNATURE TABLE:</h4>
          
          <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10px;">
            <thead>
              <tr style="background: #e5e7eb;">
                <th style="border: 1px solid #999; padding: 5px; text-align: left;">No.</th>
                <th style="border: 1px solid #999; padding: 5px; text-align: left;">Apt. No.</th>
                <th style="border: 1px solid #999; padding: 5px; text-align: left;">Owner Name</th>
                <th style="border: 1px solid #999; padding: 5px; text-align: left;">Personal Code</th>
                <th style="border: 1px solid #999; padding: 5px; text-align: left;">Signature</th>
                <th style="border: 1px solid #999; padding: 5px; text-align: left;">Date</th>
              </tr>
            </thead>
            <tbody>
              ${Array.from(
                { length: 10 },
                (_, i) => `
                <tr>
                  <td style="border: 1px solid #999; padding: 5px;">${i + 1}.</td>
                  <td style="border: 1px solid #999; padding: 5px;">&nbsp;</td>
                  <td style="border: 1px solid #999; padding: 5px;">&nbsp;</td>
                  <td style="border: 1px solid #999; padding: 5px;">&nbsp;</td>
                  <td style="border: 1px solid #999; padding: 5px;">&nbsp;</td>
                  <td style="border: 1px solid #999; padding: 5px;">&nbsp;</td>
                </tr>
              `
              ).join("")}
            </tbody>
          </table>
          
          <p style="margin-top: 15px; font-size: 9px; font-style: italic;">
            <strong>NOTE:</strong> According to Civil Code (Article 4.75), consent of ALL owners is required.
          </p>
        </div>
      `
          : ""
      }
      
      <!-- Instructions page -->
      <div style="page-break-before: always; padding-top: 0;">
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; text-align: center; margin: -20px -20px 20px -20px;">
          <h2 style="margin: 0; font-size: 18px; font-weight: bold;">INSTRUCTIONS AND NEXT STEPS</h2>
        </div>
        
        <div style="margin: 20px 0;">
          ${
            needsCoOwnerDocs
              ? `
          <div style="background: #dbeafe; border-left: 4px solid #2563eb; padding: 12px; margin: 15px 0;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px;">
              <span style="background: #2563eb; color: white; border-radius: 50%; padding: 2px 8px; margin-right: 8px;">1</span>
              Collect co-owner consents
            </h4>
            <p style="margin: 0; font-size: 10px;">
              Use the template in this PDF (Document #2). Collect all co-owner signatures or call a general meeting and confirm the decision by protocol. Time: 1-4 weeks.
            </p>
          </div>
          `
              : ""
          }
          
          <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 15px 0;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px;">
              <span style="background: #f59e0b; color: white; border-radius: 50%; padding: 2px 8px; margin-right: 8px;">${
                needsCoOwnerDocs ? "2" : "1"
              }</span>
              Obtain Real Estate Register extract
            </h4>
            <p style="margin: 0; font-size: 10px;">
              <strong>How to obtain:</strong><br/>
              • Online: <strong>www.registrucentras.lt/paslaugos</strong><br/>
              • Tel.: 1884 (weekdays 8-17)<br/>
              • Cost: 2-3 EUR<br/>
              • Duration: Immediately (electronic) or 1-3 business days
            </p>
          </div>
          
          <div style="background: #e0e7ff; border-left: 4px solid #6366f1; padding: 12px; margin: 15px 0;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px;">
              <span style="background: #6366f1; color: white; border-radius: 50%; padding: 2px 8px; margin-right: 8px;">${
                needsCoOwnerDocs ? "3" : "2"
              }</span>
              Contact ESO for connection conditions
            </h4>
            <p style="margin: 0; font-size: 10px;">
              <strong>How to obtain:</strong><br/>
              • Online: <strong>www.eso.lt</strong> > Services > New object connection<br/>
              • Tel.: <strong>1852</strong> (weekdays 8-17)<br/>
              • Duration: 5-10 business days<br/>
              • Cost: Free
            </p>
          </div>
          
          <div style="background: #dcfce7; border-left: 4px solid #10b981; padding: 12px; margin: 15px 0;">
            <h4 style="margin: 0 0 8px 0; font-size: 12px;">
              <span style="background: #10b981; color: white; border-radius: 50%; padding: 2px 8px; margin-right: 8px;">${
                needsCoOwnerDocs ? "4" : "3"
              }</span>
              Apply for ENA subsidy
            </h4>
            <p style="margin: 0; font-size: 10px;">
              <strong>Subsidy amount:</strong><br/>
              • Apartments: up to ${isApartment ? "60%" : "40%"} (max. 1,500 EUR)<br/>
              <br/>
              <strong>Application:</strong> <strong>www.ena.lt</strong><br/>
              <strong style="color: #dc2626;">⚠️ IMPORTANT:</strong> Apply BEFORE installation!
            </p>
          </div>
        </div>
        
        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 15px; margin-top: 20px;">
          <h4 style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold;">📞 CONTACTS</h4>
          <div style="font-size: 10px; line-height: 1.6;">
            <p><strong>ENA (Energy Agency):</strong> www.ena.lt, info@ena.lt</p>
            <p><strong>ESO (Electricity Distribution):</strong> www.eso.lt, tel. 1852</p>
            <p><strong>Registry Center:</strong> www.registrucentras.lt, tel. 1884</p>
          </div>
        </div>
      </div>
    </div>
  `

  const opt = {
    margin: 0,
    filename: `ev-docs-${formData.fullName.replace(/\s+/g, "-")}.pdf`,
    image: { type: "jpeg" as const, quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm" as const, format: "a4" as const, orientation: "portrait" as const },
  }

  await html2pdf().set(opt).from(htmlContent).save()
}
